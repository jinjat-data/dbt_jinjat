name: dbt_jinjat_integration_tests
runtime: yaml

resources:
  jinjat_docker_repo:
    type: gcp:artifactregistry:Repository
    properties:
      description: example docker repository
      format: DOCKER
      location: us-central1
      project: jinjat-demo
      repositoryId: jinjat-repository
  image:
    type: docker:Image
    options:
      version: v4.0.0
    properties:
      build:
          args:
            platform: linux/amd64
          context: .
          platform: "linux/amd64"
          dockerfile: test.Dockerfile
      imageName: "us-central1-docker.pkg.dev/jinjat-demo/jinjat-repository/dbt_jinjat_integration_tests:latest"
  service:
    type: gcp:cloudrunv2:Service
    properties:
      ingress: INGRESS_TRAFFIC_ALL
      location: us-central1
      name: dbt_jinjat_integration_tests
      template:
        containers:
          - image: ${image.baseImageName}
            name: jinjat-server
            ports:
              - containerPort: 8581
            envs:
              - name: HOME
                value: /root
        sessionAffinity: true

outputs:
  jinjat_docker_repo: ${jinjat_docker_repo}
  image: ${image}
  service: ${service}